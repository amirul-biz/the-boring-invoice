generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}


model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  businesses BusinessInformation[]
}

model BusinessInformation {
  id                              String   @id @default(uuid())
  userId                          String
  businessName                    String
  businessEmail                   String
  taxIdentificationNumber         String
  businessRegistrationNumber      String
  businessActivityDescription     String
  msicCode                        String
  categoryCode                    String
  userSecretKey                   String
  idType                          IdType?
  sstRegistrationNumber           String?
  address                         Json?    @db.JsonB
  invoiceVersion                  String   @default("1.0")
  createdAt                       DateTime @default(now())
  updatedAt                       DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id])
  invoices Invoice[]

  @@index([userId])
}

model Invoice {
  id                      String        @id @default(cuid())

  // === Business (optional â€” will backfill via seed) ===
  businessId              String?
  business                BusinessInformation? @relation(fields: [businessId], references: [id])

  // === Core ===
  invoiceNo               String        @unique
  invoiceType             InvoiceType
  originalInvoiceRef      String?
  currency                String        @default("MYR")
  status                  InvoiceStatus @default(PENDING)

  // === Dates ===
  issuedDate              DateTime      @default(now())
  dueDate                 DateTime

  // === Recipient (snapshot + reference key) ===
  recipientRegistrationNo String
  recipient               Json          @db.JsonB

  // === Supplier (snapshot + reference key) ===
  supplierRegistrationNo  String
  supplier                Json          @db.JsonB

  // === Items ===
  items                   Json          @db.JsonB

  // === Totals ===
  totalNetAmount          Decimal       @db.Decimal(18, 2)
  totalTaxAmount          Decimal       @db.Decimal(18, 2)
  totalDiscountAmount     Decimal       @db.Decimal(18, 2) @default(0)
  totalPayableAmount      Decimal       @db.Decimal(18, 2)

  // === Payment ===
  billCode                String?
  billUrl                 String?
  transactionId           String?
  transactionTime         DateTime?

  // === LHDN ===
  invoiceVersion          String        @default("1.0")
  lhdnMeta                Json?         @db.JsonB

  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt

  @@index([businessId])
  @@index([invoiceNo])
  @@index([recipientRegistrationNo])
  @@index([supplierRegistrationNo])
  @@index([status])
  @@index([issuedDate])
}

enum InvoiceStatus {
  DRAFT
  PENDING
  PAID
  CANCELLED
}

enum InvoiceType {
  INVOICE
  CREDIT_NOTE
  DEBIT_NOTE
}

enum IdType {
  BRN
  NRIC
  PASSPORT
  ARMY
}