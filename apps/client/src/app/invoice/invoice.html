<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Create Invoice</h2>
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-outline-primary btn-sm" (click)="onDownloadTemplate()">
        Download Excel Template
      </button>
      <button type="button" class="btn btn-outline-success btn-sm" (click)="fileInput.click()">
        Upload Excel
      </button>
      <input #fileInput type="file" accept=".xlsx,.xls" (change)="onUploadTemplate($event)" hidden>
    </div>
  </div>

  <ngx-spinner bdColor="rgba(0, 0, 0, 0.8)" size="large" color="#fff" type="ball-scale-multiple" [fullScreen]="true">
    <p style="color: white">Generating Invoice...</p>
  </ngx-spinner>

  <form [formGroup]="invoiceForm">
    <!-- Invoice Basic Info -->
    <div class="card mb-3">
      <div class="card-header">
        <h5 class="mb-0">Invoice Details</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-12 col-md-3">
            <label for="invoiceType" class="form-label">Invoice Type</label>
            <select
              class="form-select"
              [ngClass]="{'is-invalid': isFieldInvalid(invoiceForm.controls.invoiceType)}"
              id="invoiceType"
              formControlName="invoiceType">
              @for (type of invoiceTypes; track type.value) {
                <option [value]="type.value">{{ type.label }}</option>
              }
            </select>
            <div class="invalid-feedback">Invoice type is required</div>
          </div>

          <div class="col-12 col-md-3">
            <label for="currency" class="form-label">Currency</label>
            <input
              type="text"
              class="form-control"
              [ngClass]="{'is-invalid': isFieldInvalid(invoiceForm.controls.currency)}"
              id="currency"
              formControlName="currency">
            <div class="invalid-feedback">Currency is required</div>
          </div>

          <div class="col-12 col-md-3">
            <label for="dueDate" class="form-label">Due Date</label>
            <div class="input-group">
              <input
                class="form-control"
                [ngClass]="{'is-invalid': isFieldInvalid(invoiceForm.controls.dueDate)}"
                placeholder="yyyy-mm-dd"
                id="dueDate"
                formControlName="dueDate"
                ngbDatepicker
                #datepicker="ngbDatepicker">
              <button
                class="btn btn-outline-secondary"
                [ngClass]="{'border-danger': isFieldInvalid(invoiceForm.controls.dueDate)}"
                (click)="datepicker.toggle()"
                type="button">
                <i class="bi bi-calendar"></i>
              </button>
              <div class="invalid-feedback">Due date is required</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Supplier Card (Full Width) -->
    <div class="card mb-3">
      <div class="card-header">
        <h5 class="mb-0">Supplier Information</h5>
      </div>
      <div class="card-body">
        <div formGroupName="supplier">
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label for="supplierName" class="form-label">Name</label>
              <input
                type="text"
                class="form-control"
                [ngClass]="{'is-invalid': isFieldInvalid(supplier.controls.name)}"
                id="supplierName"
                formControlName="name">
              <div class="invalid-feedback">Supplier name is required</div>
            </div>

            <div class="col-12 col-md-6">
              <label for="supplierEmail" class="form-label">Email</label>
              <input
                type="email"
                class="form-control"
                [ngClass]="{'is-invalid': isFieldInvalid(supplier.controls.email)}"
                id="supplierEmail"
                formControlName="email">
              <div class="invalid-feedback">Valid email is required</div>
            </div>

            <div class="col-12 col-md-4">
              <label for="supplierTin" class="form-label">TIN</label>
              <input
                type="text"
                class="form-control"
                [ngClass]="{'is-invalid': isFieldInvalid(supplier.controls.tin)}"
                id="supplierTin"
                formControlName="tin">
              <div class="invalid-feedback">TIN is required</div>
            </div>

            <div class="col-12 col-md-4">
              <label for="supplierRegNum" class="form-label">Registration Number</label>
              <input
                type="text"
                class="form-control"
                [ngClass]="{'is-invalid': isFieldInvalid(supplier.controls.registrationNumber)}"
                id="supplierRegNum"
                formControlName="registrationNumber">
              <div class="invalid-feedback">Registration number is required</div>
            </div>

            <div class="col-12 col-md-4">
              <label for="supplierMsic" class="form-label">MSIC Code</label>
              <input
                type="text"
                class="form-control"
                [ngClass]="{'is-invalid': isFieldInvalid(supplier.controls.msicCode)}"
                id="supplierMsic"
                formControlName="msicCode"
                placeholder="85419"
                maxlength="5">
              <div class="invalid-feedback">MSIC code must be exactly 5 digits</div>
            </div>

            <div class="col-12">
              <label for="supplierActivity" class="form-label">Business Activity Description</label>
              <textarea
                class="form-control"
                [ngClass]="{'is-invalid': isFieldInvalid(supplier.controls.businessActivityDescription)}"
                id="supplierActivity"
                formControlName="businessActivityDescription"
                rows="2"></textarea>
              <div class="invalid-feedback">Business activity description is required</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recipients Card (Full Width with FormArray) -->
    <div class="card mb-3">
      <div class="card-header">
        <h5 class="mb-0">Recipient Information</h5>
      </div>
      <div class="card-body">
        <div formArrayName="recipients">
          @for (recipient of recipients.controls; track recipient) {
            <div class="card mb-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Recipient #{{ $index + 1 }}</h6>
                <button
                  type="button"
                  class="btn btn-danger btn-sm"
                  (click)="removeRecipient($index)"
                  [disabled]="!canRemoveRecipient()">
                  Remove
                </button>
              </div>
              <div class="card-body">
                <div [formGroupName]="$index">

                <div class="row g-3">
                  <div class="col-12 col-md-6">
                    <label [for]="'recipientName' + $index" class="form-label">Name</label>
                    <input
                      type="text"
                      class="form-control"
                      [ngClass]="{'is-invalid': isFieldInvalid(recipient.get('name'))}"
                      [id]="'recipientName' + $index"
                      formControlName="name"
                      autocomplete="off">
                    <div class="invalid-feedback">Recipient name is required</div>
                  </div>

                  <div class="col-12 col-md-6">
                    <label [for]="'recipientEmail' + $index" class="form-label">Email</label>
                    <input
                      type="email"
                      class="form-control"
                      [ngClass]="{'is-invalid': isFieldInvalid(recipient.get('email'))}"
                      [id]="'recipientEmail' + $index"
                      formControlName="email"
                      autocomplete="off">
                    <div class="invalid-feedback">Valid email is required</div>
                  </div>

                  <div class="col-12 col-md-4">
                    <label [for]="'recipientPhone' + $index" class="form-label">Phone</label>
                    <input
                      type="text"
                      class="form-control"
                      [ngClass]="{'is-invalid': isFieldInvalid(recipient.get('phone'))}"
                      [id]="'recipientPhone' + $index"
                      formControlName="phone"
                      autocomplete="off">
                    <div class="invalid-feedback">Phone is required</div>
                  </div>

                  <div class="col-12 col-md-4">
                    <label [for]="'recipientTin' + $index" class="form-label">
                      TIN{{ !recipient.get('tin')?.hasValidator(Validators.required) ? ' (required for B2B)' : '' }}
                    </label>
                    <input
                      type="text"
                      class="form-control"
                      [ngClass]="{'is-invalid': isFieldInvalid(recipient.get('tin'))}"
                      [id]="'recipientTin' + $index"
                      formControlName="tin"
                      autocomplete="off">
                    <div class="invalid-feedback">TIN is required</div>
                  </div>

                  <div class="col-12 col-md-2">
                    <label [for]="'recipientIdType' + $index" class="form-label">ID Type</label>
                    <select
                      class="form-select"
                      [ngClass]="{'is-invalid': isFieldInvalid(recipient.get('idType'))}"
                      [id]="'recipientIdType' + $index"
                      formControlName="idType">
                      <option value="BRN">BRN</option>
                      <option value="NRIC">NRIC</option>
                      <option value="PASSPORT">PASSPORT</option>
                      <option value="ARMY">ARMY</option>
                    </select>
                    <div class="invalid-feedback">ID type is required</div>
                  </div>

                  <div class="col-12 col-md-6">
                    <label [for]="'recipientRegNum' + $index" class="form-label">
                      Registration Number{{ !recipient.get('registrationNumber')?.hasValidator(Validators.required) ? ' (required for B2B)' : '' }}
                    </label>
                    <input
                      type="text"
                      class="form-control"
                      [ngClass]="{'is-invalid': isFieldInvalid(recipient.get('registrationNumber'))}"
                      [id]="'recipientRegNum' + $index"
                      formControlName="registrationNumber"
                      autocomplete="off">
                    <div class="invalid-feedback">Registration number is required</div>
                  </div>

                  <div class="col-12">
                    <label [for]="'recipientAddress' + $index" class="form-label">Address Line 1</label>
                    <input
                      type="text"
                      class="form-control"
                      [ngClass]="{'is-invalid': isFieldInvalid(recipient.get('addressLine1'))}"
                      [id]="'recipientAddress' + $index"
                      formControlName="addressLine1"
                      autocomplete="off">
                    <div class="invalid-feedback">Address is required</div>
                  </div>

                  <div class="col-12 col-md-3">
                    <label [for]="'recipientPostcode' + $index" class="form-label">Postcode</label>
                    <input
                      type="text"
                      class="form-control"
                      [ngClass]="{'is-invalid': isFieldInvalid(recipient.get('postcode'))}"
                      [id]="'recipientPostcode' + $index"
                      formControlName="postcode"
                      autocomplete="off">
                    <div class="invalid-feedback">Postcode is required</div>
                  </div>

                  <div class="col-12 col-md-3">
                    <label [for]="'recipientCity' + $index" class="form-label">City</label>
                    <input
                      type="text"
                      class="form-control"
                      [ngClass]="{'is-invalid': isFieldInvalid(recipient.get('city'))}"
                      [id]="'recipientCity' + $index"
                      formControlName="city"
                      autocomplete="off">
                    <div class="invalid-feedback">City is required</div>
                  </div>

                  <div class="col-12 col-md-3">
                    <label [for]="'recipientState' + $index" class="form-label">State</label>
                    <select
                      class="form-select"
                      [ngClass]="{'is-invalid': isFieldInvalid(recipient.get('state'))}"
                      [id]="'recipientState' + $index"
                      formControlName="state">
                      @for (state of malaysianStates; track state.code) {
                        <option [value]="state.code">{{ state.name }}</option>
                      }
                    </select>
                    <div class="invalid-feedback">State is required</div>
                  </div>

                  <div class="col-12 col-md-3">
                    <label [for]="'recipientCountry' + $index" class="form-label">Country Code</label>
                    <input
                      type="text"
                      class="form-control"
                      [ngClass]="{'is-invalid': isFieldInvalid(recipient.get('countryCode'))}"
                      [id]="'recipientCountry' + $index"
                      formControlName="countryCode"
                      autocomplete="off">
                    <div class="invalid-feedback">Country code is required</div>
                  </div>
                </div>
                </div>
              </div>
            </div>
          }
          <button type="button" class="btn btn-primary" (click)="addRecipient()">
            Add Recipient
          </button>
        </div>
      </div>
    </div>

    <!-- Items Card -->
    <div class="card mb-3">
      <div class="card-header">
        <h5 class="mb-0">Invoice Items</h5>
      </div>
      <div class="card-body">
        <div formArrayName="items">
          @for (item of items.controls; track item) {
            <div class="card mb-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Item #{{ $index + 1 }}</h6>
                <button
                  type="button"
                  class="btn btn-danger btn-sm"
                  (click)="removeItem($index)"
                  [disabled]="!canRemoveItem()">
                  Remove
                </button>
              </div>
              <div class="card-body">
                <div [formGroupName]="$index">

                <div class="row g-3">
                  <div class="col-12 col-md-4">
                    <label [for]="'itemName' + $index" class="form-label">Item Name</label>
                    <input
                      type="text"
                      class="form-control"
                      [ngClass]="{'is-invalid': isFieldInvalid(item.get('itemName'))}"
                      [id]="'itemName' + $index"
                      formControlName="itemName">
                    <div class="invalid-feedback">Item name is required</div>
                  </div>

                  <div class="col-12 col-md-2">
                    <label [for]="'quantity' + $index" class="form-label">Quantity</label>
                    <input
                      type="number"
                      class="form-control"
                      [ngClass]="{'is-invalid': isFieldInvalid(item.get('quantity'))}"
                      [id]="'quantity' + $index"
                      formControlName="quantity">
                    <div class="invalid-feedback">Quantity must be at least 1</div>
                  </div>

                  <div class="col-12 col-md-3">
                    <label [for]="'unitPrice' + $index" class="form-label">Unit Price</label>
                    <input
                      type="number"
                      step="0.01"
                      class="form-control"
                      [ngClass]="{'is-invalid': isFieldInvalid(item.get('unitPrice'))}"
                      [id]="'unitPrice' + $index"
                      formControlName="unitPrice">
                    <div class="invalid-feedback">Unit price must be 0 or greater</div>
                  </div>

                  <div class="col-12 col-md-3">
                    <label [for]="'classificationCode' + $index" class="form-label">Classification Code</label>
                    <select
                      class="form-select"
                      [ngClass]="{'is-invalid': isFieldInvalid(item.get('classificationCode'))}"
                      [id]="'classificationCode' + $index"
                      formControlName="classificationCode">
                      <option value="">Select a classification</option>
                      @for (classification of classificationCodes; track classification.code) {
                        <option [value]="classification.code">{{ classification.code }} - {{ classification.description }}</option>
                      }
                    </select>
                    <div class="invalid-feedback">Classification code is required</div>
                  </div>

                  <div class="col-12 col-md-2">
                    <label [for]="'taxType' + $index" class="form-label">Tax Type</label>
                    <select
                      class="form-select"
                      [ngClass]="{'is-invalid': isFieldInvalid(item.get('taxType'))}"
                      [id]="'taxType' + $index"
                      formControlName="taxType">
                      @for (tax of taxTypes; track tax.value) {
                        <option [value]="tax.value">{{ tax.label }}</option>
                      }
                    </select>
                    <div class="invalid-feedback">Tax type is required</div>
                  </div>

                  <div class="col-12 col-md-2">
                    <label [for]="'taxRate' + $index" class="form-label">Tax Rate (%)</label>
                    <input
                      type="number"
                      step="0.01"
                      class="form-control"
                      [ngClass]="{'is-invalid': isFieldInvalid(item.get('taxRate'))}"
                      [id]="'taxRate' + $index"
                      formControlName="taxRate">
                    <div class="invalid-feedback">Tax rate is required</div>
                  </div>

                  <div class="col-12 col-md-2">
                    <label [for]="'discountRate' + $index" class="form-label">Discount (%)</label>
                    <input
                      type="number"
                      step="0.01"
                      min="0"
                      max="100"
                      class="form-control"
                      [ngClass]="{'is-invalid': isFieldInvalid(item.get('discountRate'))}"
                      [id]="'discountRate' + $index"
                      formControlName="discountRate"
                      placeholder="0">
                    <div class="invalid-feedback">Discount must be 0â€“100</div>
                  </div>
                </div>
                </div>
              </div>
            </div>
          }
          <button type="button" class="btn btn-primary" (click)="addItem()">
            Add Item
          </button>
        </div>
      </div>
    </div>

    <!-- Submit Button -->
    <div class="d-flex justify-content-end">
      <button type="submit" class="btn btn-success btn-lg" (click)="onSubmit()">
        Generate Invoice
      </button>
    </div>
  </form>
</div>
