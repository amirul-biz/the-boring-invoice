<div class="container py-4">
  <h2 class="mb-4">Create Invoice</h2>

  @let form = invoiceForm.controls;

  <form [formGroup]="invoiceForm" (ngSubmit)="onSubmit()">
    <!-- Invoice Basic Info -->
    <div class="card mb-3">
      <div class="card-header">
        <h5 class="mb-0">Invoice Details</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-12 col-md-3">
            <label for="invoiceType" class="form-label">Invoice Type</label>
            <select
              class="form-select"
              [ngClass]="{'is-invalid': isFieldInvalid(invoiceForm.controls.invoiceType)}"
              id="invoiceType"
              formControlName="invoiceType">
              @for (type of invoiceTypes; track type.value) {
                <option [value]="type.value">{{ type.label }}</option>
              }
            </select>
            <div class="invalid-feedback">Invoice type is required</div>
          </div>

          <div class="col-12 col-md-3">
            <label for="currency" class="form-label">Currency</label>
            <input
              type="text"
              class="form-control"
              [ngClass]="{'is-invalid': isFieldInvalid(invoiceForm.controls.currency)}"
              id="currency"
              formControlName="currency">
            <div class="invalid-feedback">Currency is required</div>
          </div>

          <div class="col-12 col-md-3">
            <label for="taxRate" class="form-label">Tax Rate (%)</label>
            <input
              type="number"
              class="form-control"
              [ngClass]="{'is-invalid': isFieldInvalid(invoiceForm.controls.taxRate)}"
              id="taxRate"
              formControlName="taxRate">
            <div class="invalid-feedback">Tax rate is required</div>
          </div>

          <div class="col-12 col-md-3">
            <label for="dueDate" class="form-label">Due Date</label>
            <div class="input-group">
              <input
                class="form-control"
                [ngClass]="{'is-invalid': isFieldInvalid(invoiceForm.controls.dueDate)}"
                placeholder="yyyy-mm-dd"
                id="dueDate"
                formControlName="dueDate"
                ngbDatepicker
                #datepicker="ngbDatepicker">
              <button
                class="btn btn-outline-secondary"
                [ngClass]="{'border-danger': isFieldInvalid(invoiceForm.controls.dueDate)}"
                (click)="datepicker.toggle()"
                type="button">
                <i class="bi bi-calendar"></i>
              </button>
              <div class="invalid-feedback">Due date is required</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Supplier and Recipient Row -->
    <div class="row g-3 mb-3">
      <!-- Supplier Card -->
      <div class="col-12 col-md-6">
        <div class="card h-100">
          <div class="card-header">
            <h5 class="mb-0">Supplier Information</h5>
          </div>
          <div class="card-body">
            <div formGroupName="supplier">
              <div class="mb-3">
                <label for="supplierName" class="form-label">Name</label>
                <input
                  type="text"
                  class="form-control"
                  [ngClass]="{'is-invalid': isFieldInvalid(supplier.controls.name)}"
                  id="supplierName"
                  formControlName="name">
                <div class="invalid-feedback">Supplier name is required</div>
              </div>

              <div class="mb-3">
                <label for="supplierTin" class="form-label">TIN</label>
                <input
                  type="text"
                  class="form-control"
                  [ngClass]="{'is-invalid': isFieldInvalid(supplier.controls.tin)}"
                  id="supplierTin"
                  formControlName="tin">
                <div class="invalid-feedback">TIN is required</div>
              </div>

              <div class="mb-3">
                <label for="supplierRegNum" class="form-label">Registration Number</label>
                <input
                  type="text"
                  class="form-control"
                  [ngClass]="{'is-invalid': isFieldInvalid(supplier.controls.registrationNumber)}"
                  id="supplierRegNum"
                  formControlName="registrationNumber">
                <div class="invalid-feedback">Registration number is required</div>
              </div>

              <div class="mb-3">
                <label for="supplierMsic" class="form-label">MSIC Code</label>
                <input
                  type="text"
                  class="form-control"
                  [ngClass]="{'is-invalid': isFieldInvalid(supplier.controls.msicCode)}"
                  id="supplierMsic"
                  formControlName="msicCode"
                  placeholder="85419"
                  maxlength="5">
                <div class="invalid-feedback">MSIC code must be exactly 5 digits</div>
              </div>

              <div class="mb-3">
                <label for="supplierActivity" class="form-label">Business Activity Description</label>
                <textarea
                  class="form-control"
                  [ngClass]="{'is-invalid': isFieldInvalid(supplier.controls.businessActivityDescription)}"
                  id="supplierActivity"
                  formControlName="businessActivityDescription"
                  rows="2"></textarea>
                <div class="invalid-feedback">Business activity description is required</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recipient Card -->
      <div class="col-12 col-md-6">
        <div class="card h-100">
          <div class="card-header">
            <h5 class="mb-0">Recipient Information</h5>
          </div>
          <div class="card-body">
            <div formGroupName="recipient">
              <div class="mb-3">
                <label for="recipientName" class="form-label">Name</label>
                <input
                  type="text"
                  class="form-control"
                  [ngClass]="{'is-invalid': isFieldInvalid(recipient.controls.name)}"
                  id="recipientName"
                  formControlName="name">
                <div class="invalid-feedback">Recipient name is required</div>
              </div>

              <div class="mb-3">
                <label for="recipientEmail" class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  [ngClass]="{'is-invalid': isFieldInvalid(recipient.controls.email)}"
                  id="recipientEmail"
                  formControlName="email">
                <div class="invalid-feedback">Valid email is required</div>
              </div>

              <div class="mb-3">
                <label for="recipientPhone" class="form-label">Phone</label>
                <input
                  type="text"
                  class="form-control"
                  [ngClass]="{'is-invalid': isFieldInvalid(recipient.controls.phone)}"
                  id="recipientPhone"
                  formControlName="phone">
                <div class="invalid-feedback">Phone is required</div>
              </div>

              <div class="mb-3">
                <label for="recipientTin" class="form-label">
                  TIN{{ !form.recipient.controls.tin.hasValidator(Validators.required) ? ' (required for B2B)' : '' }}
                </label>
                <input
                  type="text"
                  class="form-control"
                  [ngClass]="{'is-invalid': isFieldInvalid(recipient.controls.tin)}"
                  id="recipientTin"
                  formControlName="tin">
                <div class="invalid-feedback">TIN is required</div>
              </div>

              <div class="mb-3">
                <label for="recipientRegNum" class="form-label">
                  Registration Number{{ !form.recipient.controls.registrationNumber.hasValidator(Validators.required) ? ' (required for B2B)' : '' }}
                </label>
                <input
                  type="text"
                  class="form-control"
                  [ngClass]="{'is-invalid': isFieldInvalid(recipient.controls.registrationNumber)}"
                  id="recipientRegNum"
                  formControlName="registrationNumber">
                <div class="invalid-feedback">Registration number is required</div>
              </div>

              <div class="mb-3">
                <label for="recipientAddress" class="form-label">Address Line 1</label>
                <input
                  type="text"
                  class="form-control"
                  [ngClass]="{'is-invalid': isFieldInvalid(recipient.controls.addressLine1)}"
                  id="recipientAddress"
                  formControlName="addressLine1">
                <div class="invalid-feedback">Address is required</div>
              </div>

              <div class="row g-2">
                <div class="col-6">
                  <label for="recipientPostcode" class="form-label">Postcode</label>
                  <input
                    type="text"
                    class="form-control"
                    [ngClass]="{'is-invalid': isFieldInvalid(recipient.controls.postcode)}"
                    id="recipientPostcode"
                    formControlName="postcode">
                  <div class="invalid-feedback">Postcode is required</div>
                </div>

                <div class="col-6">
                  <label for="recipientCity" class="form-label">City</label>
                  <input
                    type="text"
                    class="form-control"
                    [ngClass]="{'is-invalid': isFieldInvalid(recipient.controls.city)}"
                    id="recipientCity"
                    formControlName="city">
                  <div class="invalid-feedback">City is required</div>
                </div>
              </div>

              <div class="row g-2 mt-2">
                <div class="col-6">
                  <label for="recipientState" class="form-label">State</label>
                  <select
                    class="form-select"
                    [ngClass]="{'is-invalid': isFieldInvalid(recipient.controls.state)}"
                    id="recipientState"
                    formControlName="state">
                    @for (state of malaysianStates; track state.code) {
                      <option [value]="state.code">{{ state.name }}</option>
                    }
                  </select>
                  <div class="invalid-feedback">State is required</div>
                </div>

                <div class="col-6">
                  <label for="recipientCountry" class="form-label">Country Code</label>
                  <input
                    type="text"
                    class="form-control"
                    [ngClass]="{'is-invalid': isFieldInvalid(recipient.controls.countryCode)}"
                    id="recipientCountry"
                    formControlName="countryCode">
                  <div class="invalid-feedback">Country code is required</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Items Card -->
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Invoice Items</h5>
        <button type="button" class="btn btn-primary btn-sm" (click)="addItem()">
          Add Item
        </button>
      </div>
      <div class="card-body">
        <div formArrayName="items">
          @for (item of items.controls; track $index) {
            <div class="mb-3">
              <div [formGroupName]="$index" class="border rounded p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0">Item #{{ $index + 1 }}</h6>
                  <button
                    type="button"
                    class="btn btn-danger btn-sm"
                    (click)="removeItem($index)"
                    [disabled]="!canRemoveItem()">
                    Remove
                  </button>
                </div>

                <div class="row g-3">
                  <div class="col-12 col-md-4">
                    <label [for]="'itemName' + $index" class="form-label">Item Name</label>
                    <input
                      type="text"
                      class="form-control"
                      [ngClass]="{'is-invalid': isFieldInvalid(item.get('itemName'))}"
                      [id]="'itemName' + $index"
                      formControlName="itemName">
                    <div class="invalid-feedback">Item name is required</div>
                  </div>

                  <div class="col-12 col-md-2">
                    <label [for]="'quantity' + $index" class="form-label">Quantity</label>
                    <input
                      type="number"
                      class="form-control"
                      [ngClass]="{'is-invalid': isFieldInvalid(item.get('quantity'))}"
                      [id]="'quantity' + $index"
                      formControlName="quantity">
                    <div class="invalid-feedback">Quantity must be at least 1</div>
                  </div>

                  <div class="col-12 col-md-3">
                    <label [for]="'unitPrice' + $index" class="form-label">Unit Price</label>
                    <input
                      type="number"
                      step="0.01"
                      class="form-control"
                      [ngClass]="{'is-invalid': isFieldInvalid(item.get('unitPrice'))}"
                      [id]="'unitPrice' + $index"
                      formControlName="unitPrice">
                    <div class="invalid-feedback">Unit price must be 0 or greater</div>
                  </div>

                  <div class="col-12 col-md-3">
                    <label [for]="'classificationCode' + $index" class="form-label">Classification Code</label>
                    <select
                      class="form-select"
                      [ngClass]="{'is-invalid': isFieldInvalid(item.get('classificationCode'))}"
                      [id]="'classificationCode' + $index"
                      formControlName="classificationCode">
                      <option value="">Select a classification</option>
                      @for (classification of classificationCodes; track classification.code) {
                        <option [value]="classification.code">{{ classification.code }} - {{ classification.description }}</option>
                      }
                    </select>
                    <div class="invalid-feedback">Classification code is required</div>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Submit Button -->
    <div class="d-flex justify-content-end">
      <button type="submit" class="btn btn-success btn-lg" (click)="onSubmit()">
        Generate Invoice
      </button>
    </div>
  </form>
</div>
